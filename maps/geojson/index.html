<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8 />
	<title>RaHabit</title>

	<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
	<script src='http://api.tiles.mapbox.com/mapbox.js/v1.5.0/mapbox.js'></script>
	<script src='http://codeorigin.jquery.com/jquery-1.10.2.min.js'></script>
	<link href='http://api.tiles.mapbox.com/mapbox.js/v1.5.0/mapbox.css' rel='stylesheet' />

	<style>
		body { margin:0; padding:0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }
	</style>
</head>
<body>
	<style>
	#state {
		position:absolute;
		top:10px;
		right:10px;
		background:#fff;
		font-size:30px;
		padding:10px;
		z-index:999;
	}
	</style>
<script src='leaflet-pip.js'></script>
<div id='map'></div>
<div id='state'></div>

<script>
var map    = L.mapbox.map('map', 'examples.map-9ijuk24y').setView([19.4297430000517, -99.1283830003488], 14);
var bounds = map.getBounds();
console.log(bounds._northEast.lat);

$.ajax({
    url: '/appra/index.php/api/'+bounds._southWest.lat+','+bounds._northEast.lng+'/'+bounds._northEast.lat+','+bounds._southWest.lng+'/tianguis,schools,density',
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function load(d) {	
		/*HeatMap*/	
		var density = d.density;
		var heatmap =  L.geoJson(density, {
			style: function(feature) {
				densidad = feature.properties.densidad;
				
				if(densidad > -1    && densidad < 1000)  return { weight: 0, color: "#ffebd6" };
				if(densidad > 999   && densidad < 2000)  return { weight: 0, color: "#f5cbae" };
				if(densidad > 1999  && densidad < 5000)  return { weight: 0, color: "#eba988" };
				if(densidad > 4999  && densidad < 10000) return { weight: 0, color: "#e08465" };
				if(densidad > 9999  && densidad < 20000) return { weight: 0, color: "#d65d45" };
				if(densidad > 19999 && densidad < 30000) return { weight: 0, color: "#cc3527" };
				if(densidad > 29999) return { weight: 0, color: "#c40a0a" };
			}
		}).addTo(map);
		
		
		/*Results*/
		var resultIcon = L.icon({
			iconUrl: 'icons/rocket-24@2x.png',
			iconRetinaUrl: 'icons/rocket-24@2x.png',
			iconSize: [48, 48]
		});
		
		var results = d.results;
		for (x in results) {
			L.marker([results[x].lat, results[x].lon], {icon: resultIcon}).addTo(map).bindPopup(results[x].address);
		}
		
		
		/*Schools*/
		var schoolIcon = L.icon({
			iconUrl: 'icons/school-24.png',
			iconRetinaUrl: 'icons/school-24@2x.png',
			iconSize: [24, 24]
		});
		
		var schools = d.schools;
		for (x in schools) {
			L.marker([schools[x].lat, schools[x].lon], {icon: schoolIcon}).addTo(map).bindPopup(schools[x].title);
		}
		
		/*Tianguis*/
		var tianguisIcon = L.icon({
			iconUrl: 'icons/grocery-24.png',
			iconRetinaUrl: 'icons/grocery-24@2x.png',
			iconSize: [24, 24]
		});
		
		var tianguis = d.tianguis;
		for (x in tianguis) {
			L.marker([tianguis[x].lat, tianguis[x].lon], {icon: tianguisIcon}).addTo(map).bindPopup(tianguis[x].title);
		}
		
		/*Marker popup Open
			L.marker([schools[x].lat, schools[x].lon]).addTo(map).bindPopup(schools[x].title).openPopup();
			// 19.33694,-99.224832/19.357065,-99.262723
			
			//Centro
			// 19.41940874098225,-99.1420153900981/19.448908052669548,-99.12025429308414

			//Romero de terreros
			//19.335286999585545,-99.17621288448572/19.348596275044994,-99.16640035808086
        */
    }
});
</script>
</body>
